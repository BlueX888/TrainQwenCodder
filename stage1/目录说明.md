# stage1/ 文件目录说明（SFT 冷启动）

本文是 `stage1/` 的**目录索引/文件说明**，用于快速了解每个文件夹与关键文件的职责。更深入的实现细节见：

- `DETAILS.md`
- `../阶段一-SFT冷启动-详细实施文档.md`

> `stage1/` 默认依赖 `stage0/` 的产物：Prompt 种子库、Phaser API 索引、validator（详见 `DETAILS.md`）。

---

## 1) 总览结构（精简树）

```text
stage1/
├─ README.md
├─ DETAILS.md
├─ 目录说明.md
├─ SFT数据集格式说明.md
├─ 使用Claude API蒸馏指南.md
├─ Claude_API_集成完成.md
├─ configs/
│  └─ sft_config_example.yaml
├─ prompts/
│  └─ teacher_system_prompt.txt
├─ scripts/
│  ├─ common.py
│  ├─ api_bm25.py
│  ├─ build_distill_requests.py
│  ├─ run_teacher_mock.py
│  ├─ run_teacher_claude.py
│  ├─ test_claude_api.py
│  ├─ parse_teacher_outputs.py
│  ├─ run_validator_filter.py
│  ├─ select_best.py
│  └─ build_sft_dataset.py
└─ data/                         # 运行后生成的中间产物/数据集/报告（可能很大）
   ├─ sft_distill/
   ├─ sft_dataset/
   ├─ sft_official/
   └─ reports/
```

---

## 2) 根目录文件

- `stage1/README.md`：快速开始与管线步骤（构建请求 → 蒸馏 → 解析 → 过滤 → 筛选 → 数据集 → 训练）。
- `stage1/DETAILS.md`：实现细节文档（输入/输出 schema、每个脚本的关键逻辑与参数、FAQ）。
- `stage1/目录说明.md`：本文（目录索引）。
- `stage1/SFT数据集格式说明.md`：最终 `train/val/test.jsonl` 的字段定义、统计信息与 LLaMA-Factory 接入方式。
- `stage1/使用Claude API蒸馏指南.md`：使用 Anthropic/Claude API 进行教师蒸馏的操作指南（API Key、模型选择、成本估算、断点续跑）。
- `stage1/Claude_API_集成完成.md`：Claude API 集成工作总结与建议跑法。

---

## 3) configs/（训练配置）

- `stage1/configs/sft_config_example.yaml`：LLaMA-Factory 的 SFT 配置样例（LoRA 参数、数据集注册提示、输出目录等）。

> 训练后通常会生成 `stage1/outputs/`（由配置的 `output_dir` 决定；不一定在仓库中预先存在）。

---

## 4) prompts/（教师提示词模板）

- `stage1/prompts/teacher_system_prompt.txt`：教师系统提示词模板，包含 `{API_CONTEXT}` 占位符。
  - `build_distill_requests.py` 会把检索到的 API 上下文注入到该占位符。
  - `run_teacher_claude.py`/`test_claude_api.py` 会读取该文件作为 system prompt。

---

## 5) scripts/（数据生产线脚本）

> 这些脚本通常推荐在 `stage1/scripts/` 目录下运行；否则需要设置 `PYTHONPATH`（详见 `DETAILS.md`）。

- `stage1/scripts/common.py`：公共工具（路径、JSONL 读写、报告、缓存、检查点、进度条、代码规范化等）。
- `stage1/scripts/api_bm25.py`：BM25 检索器（默认读取 `stage0/data/api_index/phaser_api.jsonl`），用于为教师 prompt 注入相关 API。
- `stage1/scripts/build_distill_requests.py`：从 `stage0/data/prompt_seeds/prompt_seeds.jsonl` 构建蒸馏请求（system/user prompt + API 上下文）。
- `stage1/scripts/run_teacher_mock.py`：教师蒸馏 Mock（不调用外部 API），生成 `raw_outputs.jsonl` 用于验证整条管线可跑通。
- `stage1/scripts/run_teacher_claude.py`：真实教师蒸馏（Claude API），生成 `raw_outputs_claude.jsonl`。
- `stage1/scripts/test_claude_api.py`：快速验证 Claude API Key/模型调用/输出格式是否正常。
- `stage1/scripts/parse_teacher_outputs.py`：解析教师原始输出，提取 `[PLAN]` 与 ```javascript 代码块，生成候选数据与抽取代码文件。
- `stage1/scripts/run_validator_filter.py`：L1-L4 过滤（调用 `stage0/validator/src/cli.js`），输出验证结果与分层通过标记。
- `stage1/scripts/select_best.py`：L5 质量评分 + 多样性筛选（按 prompt 分组、相似度去重、每个 prompt 选 1-2 条）。
- `stage1/scripts/build_sft_dataset.py`：构建最终 SFT 数据集（LLaMA-Factory JSONL：`instruction/input/output/metadata`），并按来源/难度分层划分 train/val/test。
- `stage1/scripts/__pycache__/`：Python 自动生成缓存文件（可忽略，不属于“源文件”）。

---

## 6) data/（运行产物：蒸馏/筛选/数据集/报告）

`stage1/data/` 下内容通常由脚本生成，文件体积可能较大（尤其是 `sft_distill/codes/`）。

### 6.1 data/sft_distill/（蒸馏与过滤中间产物）

- `stage1/data/sft_distill/requests.jsonl`：蒸馏请求（由 `build_distill_requests.py` 生成）。
- `stage1/data/sft_distill/raw_outputs.jsonl`：Mock 教师输出（由 `run_teacher_mock.py` 生成）。
- `stage1/data/sft_distill/raw_outputs_claude.jsonl`：Claude 教师输出（由 `run_teacher_claude.py` 生成）。
- `stage1/data/sft_distill/candidates.jsonl`：解析后的候选数据（由 `parse_teacher_outputs.py` 生成）。
- `stage1/data/sft_distill/validated.jsonl`：L1-L4 过滤结果（由 `run_validator_filter.py` 生成）。
- `stage1/data/sft_distill/selected.jsonl`：L5 筛选后结果（由 `select_best.py` 生成）。
- `stage1/data/sft_distill/codes/`：从候选中抽取出的“纯 JS 代码文件”，通常按 `sha256.js` 命名，供 validator 复用与人工抽检。
  - 该目录可能包含成千上万文件；一般不建议手工编辑。

> 断点续跑/缓存文件也可能出现在该目录（取决于你运行时是否启用相关参数），例如 `checkpoint_*.json`、`validator_cache.jsonl` 等。

### 6.2 data/sft_dataset/（最终训练数据集）

- `stage1/data/sft_dataset/train.jsonl`
- `stage1/data/sft_dataset/val.jsonl`
- `stage1/data/sft_dataset/test.jsonl`

字段说明见：`stage1/SFT数据集格式说明.md`。

### 6.3 data/sft_official/（官方/开源补充数据）

用于放置额外的高质量样本（可选）。`build_sft_dataset.py` 默认会尝试读取：

- `stage1/data/sft_official/processed.jsonl`（如不存在则跳过官方数据合并）

### 6.4 data/reports/（统计报告）

每个阶段的摘要报告（JSON），典型包含：

- `distill_requests_report.json`
- `parse_report.json`
- `filter_report.json`
- `selection_report.json`
- `sft_dataset_report.json`

