# Stage1 过滤验证系统说明

## 概述

Stage1 使用四层过滤验证系统（L1-L4）对蒸馏生成的代码进行质量筛选，确保只有高质量的数据进入训练集。

## 验证流程

```
candidates.jsonl → L1检查 → L2检查 → L3检查 → L4检查 → validated.jsonl
                     ↓         ↓         ↓         ↓
                  语法检查   API验证   运行时验证  功能匹配
```

## 四层验证详解

### L1: 语法与基础规范检查

**检查项目：**
- `parse_ok`: 代码能被 Babel 解析（JavaScript 语法正确）
- `lint_ok`: 通过 ESLint 检查
- `banned`: 无危险用法（eval、require 等）
- `code_length`: 代码长度 ≥ 100 字符

**通过条件：** 全部检查项通过

**常见失败原因：**
- 语法错误（缺少括号、分号等）
- ESLint 规则违反
- 使用了被禁止的 API

### L2: API 语义与领域知识验证

**检查项目：**
- `miss_rate`: API 不存在率 ≤ 20%
- `must_use_hit_rate`: 必须使用的 API 命中率 ≥ 80%

**通过条件：**
- API 不存在率低于阈值
- must_use 命中率达到阈值

**实现细节（工厂方法等价识别）：**
Stage1 在调用 validator 前，会把 `prompt.must_use_apis`（通常是类名）映射为 validator 可命中的符号 ID（通常是工厂方法），例如：
- `Phaser.GameObjects.Graphics` → `Phaser.GameObjects.GameObjectFactory#graphics`
这样生成代码里的 `this.add.graphics()` 会被 AST 解析成同一个 `symbol_id`，从而计为 must_use 命中。

### L3: 运行时正确性验证

**检查项目：**
- `runtime_ok`: 代码在 Headless 浏览器中可运行
- `crashed`: 运行时不崩溃

**通过条件：** 代码能正常运行且不崩溃

**验证方式：**
使用 Puppeteer 在无头浏览器中运行 60 帧，检测是否有 JavaScript 错误。

### L4: 功能匹配度验证

**检查项目：**
- `has_new_phaser_game`: 包含 `new Phaser.Game()` 初始化
- `has_create`: 包含 `create()` 生命周期方法
- `has_preload`: 包含 `preload()` 方法（hard 难度必需）
- `plan_code_consistency`: Plan 与代码一致性 ≥ 60%

**通过条件：** 结构完整（有 Game 初始化和 create 方法）

## 使用方法

### 运行验证

```bash
cd /Users/admin/Desktop/TrainQwenCodder/stage1/scripts

# 运行完整验证流程
python run_validator_filter.py

# 跳过运行时验证（更快）
python run_validator_filter.py --skip-runtime

# 指定输入输出
python run_validator_filter.py \
  --input ../data/sft_distill/candidates.jsonl \
  --output ../data/sft_distill/validated.jsonl
```

### 查看验证报告

```bash
cat ../data/reports/filter_report.json | python -m json.tool
```

报告示例：
```json
{
  "total": 660,
  "passed": 579,
  "pass_rate": 87.73,
  "details": {
    "l1_passed": 622,
    "l2_passed": 609,
    "l3_passed": 660,
    "l4_passed": 660,
    "issue_distribution": {
      "l1_lint_failed": 38,
      "l2_high_miss_rate": 51
    }
  }
}
```

## 核心代码位置

| 文件 | 作用 |
|------|------|
| `stage1/scripts/run_validator_filter.py` | 主验证脚本，L1-L4 检查逻辑 |
| `stage0/validator/src/cli.js` | 底层验证器 CLI |
| `stage0/validator/src/ast_check.js` | AST 解析和 API 检测 |
| `stage0/validator/src/eslint_check.js` | ESLint 检查 |
| `stage0/validator/src/run_headless.js` | 运行时验证 |
| `stage2/scripts/must_use.py` | must_use_apis 映射（类名 → 符号 ID） |

## 验证器调用示例

直接调用底层验证器：

```bash
node stage0/validator/src/cli.js \
  --code-file path/to/code.js \
  --api-index stage0/data/api_index/phaser_api.jsonl \
  --timeout-ms 2000 \
  --frames 60
```

输出示例：
```json
{
  "parse_ok": true,
  "lint_ok": true,
  "banned": [],
  "api_usage": {
    "hits": [{"symbol_id": "Phaser.GameObjects.GameObjectFactory#graphics"}],
    "misses": []
  },
  "runtime_ok": true,
  "runtime": {
    "crashed": false,
    "errors": []
  },
  "signals": {
    "has_new_phaser_game": true,
    "has_create": true,
    "has_preload": false
  }
}
```

## 调整验证阈值

在 `run_validator_filter.py` 中可以调整：

```python
# L2: API 不存在率阈值
if miss_rate >= 0.2:  # 改为 0.3 可放宽限制
    issues.append('l2_high_miss_rate')

# L4: Plan-Code 一致性阈值
if consistency < 0.6:  # 改为 0.5 可放宽限制
    issues.append('l4_low_plan_code_consistency')
```

## 常见问题

### Q1: L1 通过率低怎么办？

检查生成代码的语法质量，可能需要：
- 改进教师模型的 prompt
- 在生成后添加自动修复步骤

### Q2: L2 通过率低怎么办？

如果 `miss_rate` 过高，说明代码使用了不存在的 API，需要：
- 检查 API 索引是否完整
- 改进教师模型对 Phaser API 的理解

如果主要失败原因是 `l2_must_use_miss`，通常是 prompt 的 `must_use_apis` 过于严格或映射不覆盖：
- 先检查 `stage2/scripts/must_use.py` 是否包含该 API 的映射
- 必要时为该 API 补充“类名 ↔ 工厂方法/常量/访问链”的映射

### Q3: L3 运行时验证失败怎么办？

常见原因：
- 代码依赖外部资源（图片、音频）
- 代码有逻辑错误导致崩溃
- 代码需要用户交互才能运行

### Q4: 如何添加新的验证规则？

在 `run_validator_filter.py` 中添加新的检查函数：

```python
def check_l5(validator_result: dict, candidate: dict) -> Tuple[bool, List[str]]:
    """自定义检查"""
    issues = []
    # 添加检查逻辑
    passed = len(issues) == 0
    return passed, issues
```

## 数据流向

```
requests.jsonl (6000条)
       ↓
   Claude API 蒸馏
       ↓
raw_outputs_claude.jsonl
       ↓
   parse_teacher_outputs.py
       ↓
candidates.jsonl (660条)
       ↓
   run_validator_filter.py (L1-L4)
       ↓
validated.jsonl (660条，带验证结果)
       ↓
   select_best.py (筛选通过的)
       ↓
selected.jsonl (579条)
       ↓
   build_sft_dataset.py
       ↓
train.jsonl / val.jsonl / test.jsonl
```

## 当前验证结果

```
总数: 660
L1 通过: 622 (94.24%)  - 语法检查
L2 通过: 609 (92.27%)  - API 验证
L3 通过: 660 (100.0%)  - 运行时验证
L4 通过: 660 (100.0%)  - 功能匹配
全部通过: 579 (87.73%)
```
